# Clair 소개
Clair는 애플리케이션 컨테이너 (현재 OCI 및 도커 포함 )의 취약점에 대한 정적 분석을 위한 오픈소스 프로젝트
클라이언트는 Clair API를 사용하여 컨테이너 이미지를 색인화한 다음 알려진 취약점과 대조 가능
Clair의 목표는 컨테이너 기반 인프라의 보안을 보다 투명하게 볼 수 있도록 하는 것
## 컨테이너 보안
- 개발 단계에서 이루어짐
	- 정적 코드 분석
		- 소나큐브, 자코코
	- 종속성 확인
	- 컨테이너 이미지 스캔
		- 이미지 빌드할때 스캐닝 -> Clair 사용
![[Pasted image 20220804221122.png]]
## Clair 아키텍처
![[Pasted image 20220804221638.png]]
## Clair 작동방식
1. indexing 
	1. 메니페스트를 클레이어 전송
	2. 인덱싱을 수신 받으면 해당 컨테이너의 레이어 정보 가져옴
	3. 해당 컨텐츠 스캔
	4. 인덱스 레포츠 반환
	5. 메니페이스트는 컨테이너 이미지에 대한 클레이 명세 내용
	6. 클레어는 OCI 메니페스트 및 레이어간 중복작업을 줄이기 위해 컨텐츠 주소를 지정한다는 기능 활용
	7. 메니페스트가 인덱싱되면 나중에 검색할 수 있도록 인덱스 레포트가 유지
2. maching
	1. 매칭은 인덱스 레포트를 가져오고 레포트가 나타내는 메니페스트의 영향을 미치는 관련 취약점을 연결
	2. 클레어는 지속적으로 새로운 보안 데이터를 수집
	3. 매칭서버에 대한 요청을 통해 항상 인덱스 레포트에 최신 취약점을 분석하고 제공
3. notification
	1. 클레어는 노티피케이션을 통해 알람서비스를 구현
	2. 새로운 취약점이 발견되면 알람서비스는 이러한 취약점에 인덱싱된 메니페스트에 영향을 미치는지 확인
![[Pasted image 20220804221749.png]]
## Clair를 통한 컨테이너 이미지 분석 방식
1. 특정 이미지 레포지토리에 컨테이너 이미지가 있어야지 접근해서 분석 수행 가능
2. 레지스트리에 있는 컨테이너 이미지를 사용해서 해당 레이어의 HTTP URL을 통해 레이어의 tar파일을 가져와 분석
3. 분석한 이미지 레이어 외에 다른 레이어를 분석하기 위해 다른 API 엔드포인트를 통해서 tar파일을 얻음
4. 이러한 API 호출 방식에 따라 클레어가 컨테이너 이미지를 각각의 이미지 레이어별로 수행 가능
5. 클레어에게 하나로 통합된 스캔가능한 레이어로 구성된 도커이미지를 통합적으로 분석할 수 있도록 진행을 할수있음
6. 이를 위해 몇가지 매개변수를 사전에 작성하여 HTTP post방식으로 호출해 클레어가 분석한 결과값들을 취합해서 json형태로 리턴 가능
![[Pasted image 20220804222319.png]]
## clairctl를 통한 보안 취약점 스캔
![[Pasted image 20220804222810.png]]
## Clair & Jenkins CI 연동
- 클레어는 빨간색 부분
- 클레어는 개발자가 코드 커밋한다음 젠킨스가 컨테이너 이미지를 빌드하는 트리거를 요청하는 CICD 워크 플로우를 원할하게 연결하고 연동할 수 있도록 설계

![[Pasted image 20220804222941.png]]